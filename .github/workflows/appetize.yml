name: Upload to Appetize

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    env:
      APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
      APPETIZE_PUBLIC_KEY: ${{ secrets.APPETIZE_PUBLIC_KEY }}

    steps:
      - name: Verify Appetize token is configured
        run: |
          if [ -z "$APPETIZE_API_TOKEN" ]; then
            echo "::error ::The APPETIZE_API_TOKEN secret is not set."
            echo "Configure APPETIZE_API_TOKEN in the repository secrets to enable uploads." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android debug APK
        run: flutter build apk --debug

      - name: Upload build to Appetize
        env:
          APK_PATH: build/app/outputs/flutter-apk/app-debug.apk
        run: |
          if [ ! -f "$APK_PATH" ]; then
            echo "::error ::APK not found at $APK_PATH"
            exit 1
          fi

            if [ -n "$APPETIZE_PUBLIC_KEY" ]; then
              echo "Updating existing Appetize app ($APPETIZE_PUBLIC_KEY)" >> "$GITHUB_STEP_SUMMARY"
              RESPONSE=$(curl --fail-with-body -sS \
                -X PUT "https://api.appetize.io/v1/apps/$APPETIZE_PUBLIC_KEY" \
                -H "X-API-KEY: $APPETIZE_API_TOKEN" \
                -H "Accept: application/json" \
                -F "file=@$APK_PATH" \
                -F "platform=android")
            else
              echo "Creating new Appetize app" >> "$GITHUB_STEP_SUMMARY"
              RESPONSE=$(curl --fail-with-body -sS \
                -X POST https://api.appetize.io/v1/apps \
                -H "X-API-KEY: $APPETIZE_API_TOKEN" \
                -H "Accept: application/json" \
                -F "file=@$APK_PATH" \
                -F "platform=android")
          fi

            printf '%s' "$RESPONSE" > appetize_response.json

            python - <<'PY'
            import json
            import os
            import sys

            path = "appetize_response.json"
            with open(path, "r", encoding="utf-8") as fh:
                data = json.load(fh)

            def find_value(payload, *paths):
                for path in paths:
                    value = payload
                    for key in path:
                        if isinstance(value, dict):
                            value = value.get(key)
                        elif isinstance(value, list):
                            next_value = None
                            for item in value:
                                if isinstance(item, dict) and key in item:
                                    next_value = item.get(key)
                                    break
                            value = next_value
                        else:
                            value = None
                            break
                    if value not in (None, ""):
                        return value
                return None

            public_key = find_value(
                data,
                ("publicKey",),
                ("public_key",),
                ("data", "publicKey"),
                ("data", "public_key"),
                ("data", "attributes", "publicKey"),
                ("data", "attributes", "public_key"),
                ("data", "app", "publicKey"),
                ("data", "app", "public_key"),
            )

            public_url = find_value(
                data,
                ("publicUrl",),
                ("public_url",),
                ("links", "public"),
                ("data", "publicUrl"),
                ("data", "public_url"),
                ("data", "links", "public"),
                ("data", "attributes", "publicUrl"),
                ("data", "attributes", "public_url"),
                ("data", "attributes", "links", "public"),
                ("data", "app", "publicUrl"),
                ("data", "app", "public_url"),
                ("data", "app", "links", "public"),
            )

            private_url = find_value(
                data,
                ("privateUrl",),
                ("private_url",),
                ("links", "private"),
                ("data", "privateUrl"),
                ("data", "private_url"),
                ("data", "links", "private"),
                ("data", "attributes", "privateUrl"),
                ("data", "attributes", "private_url"),
                ("data", "attributes", "links", "private"),
                ("data", "app", "privateUrl"),
                ("data", "app", "private_url"),
                ("data", "app", "links", "private"),
            )

            if not public_key:
                print("::error ::Could not find public key in Appetize response")
                print(json.dumps(data, indent=2))
                sys.exit(1)

            summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
            if summary_path:
                with open(summary_path, "a", encoding="utf-8") as summary:
                    summary.write("### Appetize upload\n")
                    summary.write(f"- Public key: {public_key}\n")
                    summary.write(f"- Public URL: {public_url or 'N/A'}\n")
                    summary.write(f"- Private URL: {private_url or 'N/A'}\n")

            output_path = os.environ.get("GITHUB_OUTPUT")
            if output_path:
                with open(output_path, "a", encoding="utf-8") as output:
                    output.write(f"public_key={public_key}\n")
                    if public_url:
                        output.write(f"public_url={public_url}\n")
                    if private_url:
                        output.write(f"private_url={private_url}\n")
            PY

          if [ -z "$APPETIZE_PUBLIC_KEY" ]; then
            echo "::notice ::Save the reported Appetize public key as APPETIZE_PUBLIC_KEY for future updates."
          fi
